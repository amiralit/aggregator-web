package com.fieryinferno.aggregator.gateway;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.commons.lang.Validate;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.springframework.web.client.RestTemplate;

import java.io.IOException;
import java.util.Optional;


/**
 * Created by atahmasebi on 4/24/16.
 */
@Component
public class MatchGatewayImpl implements MatchGateway {

    private static final Logger LOGGER = LoggerFactory.getLogger(MatchGatewayImpl.class);

    @Autowired
    private RestTemplate restTemplate;

    @Override
    public Optional<JsonNode> getMatches(int round) {
        final String url = "http://www.resultados-futbol.com/scripts/api/api.php?key=40b2f1fd2a56cbd88df8b2c9b291760f&req=matchs&format=json&lang=en&league=177&round="+round;
        LOGGER.info("calling getMatches: {}", url);
        final String response = restTemplate.getForObject(url, String.class);
        //final String response = "{\"match\":[{\"id\":\"347342\",\"year\":\"2016\",\"group\":\"1\",\"total_group\":\"4\",\"round\":\"1\",\"local\":\"United States\",\"visitor\":\"Colombia\",\"league_id\":\"20048\",\"team1\":\"580020\",\"team2\":\"590326\",\"dteam1\":\"3810\",\"dteam2\":\"3774\",\"numc\":\"0\",\"no_hour\":false,\"local_abbr\":\"USA\",\"visitor_abbr\":\"COL\",\"competition_name\":\"Copa America\",\"playoffs\":false,\"group_code\":\"1\",\"coef\":\"65.657\",\"local_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3810.jpg?size=60x&ext=png&lossy=1&1\",\"visitor_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3774.jpg?size=60x&ext=png&lossy=1&1\",\"extraTxt\":\"In 1 month\",\"schedule\":\"2016-06-04 03:30:00\",\"date\":\"2016\\/06\\/04\",\"hour\":\"03\",\"minute\":\"30\",\"local_goals\":\"x\",\"visitor_goals\":\"x\",\"result\":\"x-x\",\"live_minute\":\"\",\"status\":-1,\"channels\":[],\"winner\":0,\"penaltis1\":0,\"penaltis2\":0},{\"id\":\"347343\",\"year\":\"2016\",\"group\":\"1\",\"total_group\":\"4\",\"round\":\"1\",\"local\":\"Costa Rica\",\"visitor\":\"Paraguay\",\"league_id\":\"20048\",\"team1\":\"590325\",\"team2\":\"590321\",\"dteam1\":\"3813\",\"dteam2\":\"3773\",\"numc\":\"0\",\"no_hour\":false,\"local_abbr\":\"CRC\",\"visitor_abbr\":\"PAR\",\"competition_name\":\"Copa America\",\"playoffs\":false,\"group_code\":\"1\",\"coef\":\"65.657\",\"local_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3813.jpg?size=60x&ext=png&lossy=1&1\",\"visitor_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3773.jpg?size=60x&ext=png&lossy=1&1\",\"extraTxt\":\"In 1 month\",\"schedule\":\"2016-06-04 23:00:00\",\"date\":\"2016\\/06\\/04\",\"hour\":\"23\",\"minute\":\"00\",\"local_goals\":\"x\",\"visitor_goals\":\"x\",\"result\":\"x-x\",\"live_minute\":\"\",\"status\":-1,\"channels\":[],\"winner\":0,\"penaltis1\":0,\"penaltis2\":0},{\"id\":\"347345\",\"year\":\"2016\",\"group\":\"2\",\"total_group\":\"4\",\"round\":\"1\",\"local\":\"Hait\\u00ed\",\"visitor\":\"Peru\",\"league_id\":\"20049\",\"team1\":\"590323\",\"team2\":\"590319\",\"dteam1\":\"5582\",\"dteam2\":\"3777\",\"numc\":\"0\",\"no_hour\":false,\"local_abbr\":\"HAI\",\"visitor_abbr\":\"PER\",\"competition_name\":\"Copa America\",\"playoffs\":false,\"group_code\":\"2\",\"coef\":\"65.657\",\"local_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/5582.jpg?size=60x&ext=png&lossy=1&1\",\"visitor_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3777.jpg?size=60x&ext=png&lossy=1&1\",\"extraTxt\":\"In 1 month\",\"schedule\":\"2016-06-05 01:30:00\",\"date\":\"2016\\/06\\/05\",\"hour\":\"01\",\"minute\":\"30\",\"local_goals\":\"x\",\"visitor_goals\":\"x\",\"result\":\"x-x\",\"live_minute\":\"\",\"status\":-1,\"channels\":[],\"winner\":0,\"penaltis1\":0,\"penaltis2\":0},{\"id\":\"347344\",\"year\":\"2016\",\"group\":\"2\",\"total_group\":\"4\",\"round\":\"1\",\"local\":\"Brazil\",\"visitor\":\"Ecuador\",\"league_id\":\"20049\",\"team1\":\"580021\",\"team2\":\"590328\",\"dteam1\":\"3775\",\"dteam2\":\"3771\",\"numc\":\"0\",\"no_hour\":false,\"local_abbr\":\"BRA\",\"visitor_abbr\":\"ECU\",\"competition_name\":\"Copa America\",\"playoffs\":false,\"group_code\":\"2\",\"coef\":\"65.657\",\"local_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3775.jpg?size=60x&ext=png&lossy=1&1\",\"visitor_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3771.jpg?size=60x&ext=png&lossy=1&1\",\"extraTxt\":\"In 1 month\",\"schedule\":\"2016-06-05 04:00:00\",\"date\":\"2016\\/06\\/05\",\"hour\":\"04\",\"minute\":\"00\",\"local_goals\":\"x\",\"visitor_goals\":\"x\",\"result\":\"x-x\",\"live_minute\":\"\",\"status\":-1,\"channels\":[],\"winner\":0,\"penaltis1\":0,\"penaltis2\":0},{\"id\":\"347347\",\"year\":\"2016\",\"group\":\"3\",\"total_group\":\"4\",\"round\":\"1\",\"local\":\"Jamaica\",\"visitor\":\"Venezuela\",\"league_id\":\"20050\",\"team1\":\"590324\",\"team2\":\"590320\",\"dteam1\":\"6219\",\"dteam2\":\"3772\",\"numc\":\"0\",\"no_hour\":false,\"local_abbr\":\"JAM\",\"visitor_abbr\":\"VEN\",\"competition_name\":\"Copa America\",\"playoffs\":false,\"group_code\":\"3\",\"coef\":\"65.657\",\"local_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/6219.jpg?size=60x&ext=png&lossy=1&1\",\"visitor_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3772.jpg?size=60x&ext=png&lossy=1&1\",\"extraTxt\":\"In 1 month\",\"schedule\":\"2016-06-05 23:00:00\",\"date\":\"2016\\/06\\/05\",\"hour\":\"23\",\"minute\":\"00\",\"local_goals\":\"x\",\"visitor_goals\":\"x\",\"result\":\"x-x\",\"live_minute\":\"\",\"status\":-1,\"channels\":[],\"winner\":0,\"penaltis1\":0,\"penaltis2\":0},{\"id\":\"347346\",\"year\":\"2016\",\"group\":\"3\",\"total_group\":\"4\",\"round\":\"1\",\"local\":\"Mexico\",\"visitor\":\"Uruguay\",\"league_id\":\"20050\",\"team1\":\"580022\",\"team2\":\"590329\",\"dteam1\":\"3811\",\"dteam2\":\"3768\",\"numc\":\"0\",\"no_hour\":false,\"local_abbr\":\"MEX\",\"visitor_abbr\":\"URU\",\"competition_name\":\"Copa America\",\"playoffs\":false,\"group_code\":\"3\",\"coef\":\"65.657\",\"local_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3811.jpg?size=60x&ext=png&lossy=1&1\",\"visitor_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3768.jpg?size=60x&ext=png&lossy=1&1\",\"extraTxt\":\"In 1 month\",\"schedule\":\"2016-06-06 02:00:00\",\"date\":\"2016\\/06\\/06\",\"hour\":\"02\",\"minute\":\"00\",\"local_goals\":\"x\",\"visitor_goals\":\"x\",\"result\":\"x-x\",\"live_minute\":\"\",\"status\":-1,\"channels\":[],\"winner\":0,\"penaltis1\":0,\"penaltis2\":0},{\"id\":\"347349\",\"year\":\"2016\",\"group\":\"4\",\"total_group\":\"4\",\"round\":\"1\",\"local\":\"Panama\",\"visitor\":\"Bolivia\",\"league_id\":\"20051\",\"team1\":\"590322\",\"team2\":\"590318\",\"dteam1\":\"17581\",\"dteam2\":\"3769\",\"numc\":\"0\",\"no_hour\":false,\"local_abbr\":\"PAN\",\"visitor_abbr\":\"BOL\",\"competition_name\":\"Copa America\",\"playoffs\":false,\"group_code\":\"4\",\"coef\":\"65.657\",\"local_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/17581.jpg?size=60x&ext=png&lossy=1&1\",\"visitor_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3769.jpg?size=60x&ext=png&lossy=1&1\",\"extraTxt\":\"In 1 month\",\"schedule\":\"2016-06-07 01:00:00\",\"date\":\"2016\\/06\\/07\",\"hour\":\"01\",\"minute\":\"00\",\"local_goals\":\"x\",\"visitor_goals\":\"x\",\"result\":\"x-x\",\"live_minute\":\"\",\"status\":-1,\"channels\":[],\"winner\":0,\"penaltis1\":0,\"penaltis2\":0},{\"id\":\"347348\",\"year\":\"2016\",\"group\":\"4\",\"total_group\":\"4\",\"round\":\"1\",\"local\":\"Argentina\",\"visitor\":\"Chile\",\"league_id\":\"20051\",\"team1\":\"580023\",\"team2\":\"590327\",\"dteam1\":\"3770\",\"dteam2\":\"3776\",\"numc\":\"0\",\"no_hour\":false,\"local_abbr\":\"ARG\",\"visitor_abbr\":\"CHI\",\"competition_name\":\"Copa America\",\"playoffs\":false,\"group_code\":\"4\",\"coef\":\"65.657\",\"local_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3770.jpg?size=60x&ext=png&lossy=1&1\",\"visitor_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3776.jpg?size=60x&ext=png&lossy=1&1\",\"extraTxt\":\"In 1 month\",\"schedule\":\"2016-06-07 04:00:00\",\"date\":\"2016\\/06\\/07\",\"hour\":\"04\",\"minute\":\"00\",\"local_goals\":\"x\",\"visitor_goals\":\"x\",\"result\":\"x-x\",\"live_minute\":\"\",\"status\":-1,\"channels\":[],\"winner\":0,\"penaltis1\":0,\"penaltis2\":0}],\"twolegged\":0,\"linked_matches\":0}";

        try {
            return Optional.ofNullable(new ObjectMapper().readTree(response));
        } catch (IOException e) {
            LOGGER.error("error getting matches for round:" + round, e);
        }

        return Optional.empty();
    }

    @Override
    public Optional<JsonNode> getMatcheDetails(String matchId) {
        Validate.notNull(matchId);
        final String url = "http://www.resultados-futbol.com/scripts/api/api.php?key=40b2f1fd2a56cbd88df8b2c9b291760f&req=match&format=json&lang=en&year=2016&id=" + matchId;

        final String response = restTemplate.getForObject(url, String.class);
//        final String response = "{\"id\":\"347342\",\"extra_data\":[],\"isWall\":false,\"isLive\":false,\"isLineup\":\"0\",\"isReport\":\"\",\"datateam1\":\"3810\",\"datateam2\":\"3774\",\"chairman_local\":\"Sunil Gulati\",\"chairman_visitor\":\"Ram\\u00f3n Jesurun\",\"team1\":\"580020\",\"team2\":\"590326\",\"local\":\"United States\",\"basealias1\":\"seleccion-estados-unidos\",\"basealias2\":\"seleccion-colombia\",\"group_code\":\"1\",\"total_group\":\"4\",\"local_goals\":\"x\",\"pen1\":0,\"pen2\":0,\"visitor\":\"Colombia\",\"visitor_goals\":\"x\",\"league\":\"Copa America\",\"schedule\":\"2016-06-04 03:30:00\",\"team1_twitter\":\"\",\"team2_twitter\":\"@FCFSeleccionCol\",\"local_abbr\":\"USA\",\"visitor_abbr\":\"COL\",\"result\":\"x-x\",\"playoffs\":false,\"last_comment\":\"2016-04-17 18:17:53\",\"category_id\":\"177\",\"round\":\"1\",\"league_id\":\"20048\",\"total_rounds\":\"3\",\"numc\":\"0\",\"year\":\"2016\",\"competition_logo\":\"http:\\/\\/thumb.resfu.com\\/media\\/img\\/league_logos\\/copa_america_2016.png?size=60x&ext=png&lossy=1&1\",\"prorroga\":false,\"no_hour\":false,\"has_alerts\":1,\"stadium\":\"The Home Depot Center\",\"img_stadium\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/estadios\\/original\\/3810.jpg?size=640x460&ext=png&lossy=1&1\",\"attendance\":null,\"seats\":\"30510\",\"fans\":null,\"typefield\":\"\",\"yearBuilt\":\"0\",\"address\":\"U.S. Soccer House 1801 S. Prairie Avenue CHICAGO IL 60616\",\"telephone\":\"1-312\\/808 1300\",\"fax\":\"1-312\\/808 1301\",\"size\":\"\",\"winner\":\"0\",\"weather\":null,\"temperature\":null,\"local_coach\":\"J\\u00fcrgen Klinsmann\",\"visitor_coach\":\"Jos\\u00e9 N\\u00e9stor P\\u00e9kerman\",\"channels\":[],\"live_minute\":\"\",\"status\":-1,\"has_players_stats\":false,\"squad\":{\"local\":[],\"visitor\":[]},\"team1_stats\":[],\"team2_stats\":[],\"match_stats\":[],\"tables\":[],\"rand\":2022275176,\"local_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3810.jpg?size=60x&ext=png&lossy=1&1\",\"visitor_shield\":\"http:\\/\\/thumb.resfu.com\\/img_data\\/escudos\\/medium\\/3774.jpg?size=60x&ext=png&lossy=1&1\",\"progression\":[],\"referee\":\"\",\"events_last_update\":1461630623,\"lineups\":[],\"bet\":[],\"quiniela_forecast\":{\"r1\":\"46\",\"rX\":\"27\",\"r2\":\"222\"},\"has_bet\":false,\"hasComments\":true,\"hasNews\":false,\"aggregate\":\"\",\"forceEvents\":false}";

        try {
            return Optional.ofNullable(new ObjectMapper().readTree(response));
        } catch (IOException e) {
            LOGGER.error("error getting match detail for match " + matchId, e);
        }

        return Optional.empty();
    }
}
